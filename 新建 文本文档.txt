#include <ESP8266WiFi.h>
#define LED_BUILTIN 2
#include "DHT.h"

#define DHTPIN 2     
#define DHTTYPE DHT11   // DHT 11

DHT dht(DHTPIN, DHTTYPE);



const char *ssid     = "Redmi";//这里是我的wifi，你使用时修改为你要连接的wifi ssid
const char *password = "13865252074hx";//你要连接的wifi密码
const char *host = "192.168.43.82";//修改为手机的的tcpServer服务端的IP地址，即手机在路由器上的ip
WiFiClient client;
const int tcpPort = 1234;//修改为你建立的Server服务端的端口号

void setup()
{
  Serial.begin(115200);
  Serial.println(F("DHTxx test!"));

  dht.begin();
  pinMode(LED_BUILTIN, OUTPUT);
 
  delay(10);
  Serial.println();
  Serial.println();
  Serial.print("Connecting to ");//写几句提示
  Serial.println(ssid);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED)//WiFi.status() ，这个函数是wifi连接状态，返回wifi链接状态
    //这里就不一一赘述它返回的数据了，有兴趣的到ESP8266WiFi.cpp中查看
  {
    delay(500);
    Serial.print(".");
  }//如果没有连通向串口发送.....

  Serial.println("");
  Serial.println("WiFi connected");
  Serial.println("IP address: ");
  Serial.println(WiFi.localIP());//WiFi.localIP()返回8266获得的ip地址
}

//把串口数据发送到客户端
void SendData() 
{
  if (Serial.available()) {   //串口读取到的转发到wifi，因为串口是一位一位的发送所以在这里缓存完再发送
    size_t counti = Serial.available();
    uint8_t sbuf[counti];
    Serial.readBytes(sbuf, counti);
    //Serial.write(sbuf, counti);
    //将数据发送给客户端
    for (int i = 0; i < 10; i++) {
      if (client && client.connected()) {
        client.write(sbuf, counti);
        delay(200);
      }
    }
  } else {
    //khhk
  }
}

void loop()
{

  float h = dht.readHumidity();
  float t = dht.readTemperature();
  float f = dht.readTemperature(true);
  if (isnan(h) || isnan(t) || isnan(f)) {
    Serial.println(F("Failed to read from DHT sensor!"));
    return;
  }

  float hif = dht.computeHeatIndex(f, h);
  float hic = dht.computeHeatIndex(t, h, false);
  while (!client.connected())//几个非连接的异常处理
  {
    if (!client.connect(host, tcpPort))
    {
      Serial.println("connection....");
      //client.stop();
      delay(500);
    }
  }
  while (client.available())//available()同ARDUINO，不解释了
  {
    char val = client.read();//read()同arduino
    if (val == 'a') { //pc端发送a和b来控制
      digitalWrite(LED_BUILTIN, HIGH);
      for(int i = 0;i<=9;i++){
        h = dht.readHumidity();
        t = dht.readTemperature();
        f = dht.readTemperature(true);
        if (isnan(h) || isnan(t) || isnan(f)) {
          Serial.println(F("Failed to read from DHT sensor!"));
          return;
        }
        hif = dht.computeHeatIndex(f, h);
        hic = dht.computeHeatIndex(t, h, false);
        String s1 = String(h);
        String s2 = String(t);
        String s3 = String(f);
        String s4 = String(hic);
        String s5 = String(hif);
        client.print("\nHumidity:"+s1+"% \nTemperature: "+s2+"°C  "+s3+"°F \nHeat index: "+s4+"°C  "+s5+"°F\n");
        delay(2000);
        
      }
    }
    if (val == 'b')
    {
      digitalWrite(LED_BUILTIN, LOW);
      client.write("已开灯");
    }
  }
  delay(2000);
  Serial.print(F("Humidity: "));
  Serial.print(h);
  Serial.print(F("%  Temperature: "));
  Serial.print(t);
  Serial.print(F("°C "));
  Serial.print(f);
  Serial.print(F("°F  Heat index: "));
  Serial.print(hic);
  Serial.print(F("°C "));
  Serial.print(hif);
  Serial.println(F("°F"));
}